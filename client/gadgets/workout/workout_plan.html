<!DOCTYPE html>
<html>
    <head>
        <title>Workout Planner</title>
        <meta charset="utf-8">
        <style>
            *{
                margin: 0;
                padding: 0;
            }
            body {
                margin: 1rem;
            }
            header {
                text-align: center;
            }
            main{
                display: flex;
                flex-direction: column;
                gap: 1rem;
                justify-content: center;
                align-items: center;
            }
            #workout-panel {
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 0.25rem;
                margin: 1rem;
            }
            #workout-container {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 1rem;
            }
            section{
                width: 350px;
                border: 2px solid black;
                border-radius: 2rem;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;

                input {
                    font-size: 1.5rem;
                    text-align: center;
                }

                input.show {
                    border: none;
                    font-size: 1.5rem;
                    text-align: center;
                    cursor: default;
                }
                input:focus.show {
                    outline: none;
                }

                ul {
                    list-style: none;
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                }
                
                li > ul {
                    display: flex;
                    flex-direction: row;
                    justify-content: end;
                    align-items: end;
                    gap: 1rem;
                    text-align: end;
                }
            }

            .button-panel {
                display: flex;
                flex-direction: row;
                gap: 0.5rem;
            }

            .show{
                display: flex;
            }
            .hide{
                display: none;
            }

            .notification {
                background-color: rgba(2, 255, 2, 0.708);
                padding: 0.5rem;
                opacity: 0;
                pointer-events: none;
                transition: opacity 1s ease-out;
            }

            .notification.show {
                opacity: 1;
                pointer-events: auto;
            }

        </style>
    </head>
    <body>
        <header>
            <h1>Workout Planner</h1>
        </header>
        <main>
            <button id="create-btn" type="button">Create New Workout</button>
            <button id="edit-mode-btn" type="button">Edit Workout</button>
            
            <form id="workout-panel" class="hide">
                <h2>New Workout</h2>

                <label for="name">Workout Name: </label>
                <input id="name" name="name" type="text" required>
                <button id="add-workout" type="button">Add Workout Plan</button>
            </form>

            <p id="notification" class="notification"></p>
            
            <div id="workout-container">
            </div>
        </main>

        <script>
            const workoutContainer = document.getElementById("workout-container");
            const workoutPanel = document.getElementById("workout-panel");
            const createBtn = document.getElementById("create-btn");
            const addWorkoutBtn = document.getElementById("add-workout");
            const editBtn = document.getElementById("edit-mode-btn");
            const notification = document.getElementById("notification");

            /*******************
                Server-side
            *******************/
            async function serverGetWorkouts() {
                const response = await fetch("http://localhost:5000/workoutplans", {
                    method: "GET"
                });
                const workouts = await response.json();
                return workouts;
            }

            async function serverGetExercises(workoutID) {
                const response = await fetch(`http://localhost:5000/workoutplans/${workoutID}`, {
                    method: "GET"
                });
                const exercises = await response.json();
                return exercises;
            }

            async function serverCreateWorkout(workoutName) {
                const response = await fetch("http://localhost:5000/workoutplans", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: workoutName })
                });
                const newWorkout = await    response.json();
                return newWorkout;
            }

            async function serverUpdateWorkout(workoutId, workoutName) {
                const response = await fetch(`http://localhost:5000/workoutplans/${workoutId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: workoutName })
                });
                const updatedWorkout = await response.json();
                return updatedWorkout;
            }

            async function serverDeleteWorkout(workoutId) {
                const response = await fetch(`http://localhost:5000/workoutplans/${workoutId}`, {
                    method: "DELETE"
                });
                const message = (await response.json()).message;
                return message;
            }

            async function serverDeleteExercise(workoutId, exerciseId) {
                const response = await fetch(`http://localhost:5000/workoutplans/${workoutId}/${exerciseId}`, {
                    method: "DELETE"
                });
                const message = (await response.json()).message;
                return message;
            }

            /*******************
                Client-side
            *******************/
            async function createWorkout(workout) {
                // Create workout section
                const workoutSection = document.createElement("section");
                workoutSection.id = workout.wid;
                
                // Workout Name
                const workoutName = document.createElement("input");
                workoutName.value = workout.name;
                workoutName.disabled = true;
                workoutName.name = "workout-name";
                workoutName.classList.add("show");

                const editWorkoutNameBtn = document.createElement("button");
                editWorkoutNameBtn.type = "button";
                editWorkoutNameBtn.textContent = "Done";
                editWorkoutNameBtn.classList.add("hide");
                editWorkoutNameBtn.classList.add('edit-name');

                // Workout Exercises
                const workoutExercises = document.createElement("ul");
                workoutExercises.classList = "exercise-list";

                const exerciseList = await serverGetExercises(workout.wid);
                
                if (exerciseList.length > 0) {
                    exerciseList.forEach(exercise => {
                    const exerciseComponent = document.createElement("li");
                    exerciseComponent.value = exercise.eid;
                    
                    const exerciseItem = document.createElement("ul");
                    const exerciseName = document.createElement("li");
                    exerciseName.textContent = exercise.name;
                    const exerciseSets = document.createElement("li");
                    exerciseSets.textContent = exercise.sets + "sets";
                    const exerciseWeight = document.createElement("li");
                    exerciseWeight.textContent = exercise.weight + "lbs";
                    const exerciseReps = document.createElement("li");
                    exerciseReps.textContent = exercise.reps + "reps";
                    
                    const exerciseDeleteBtn = document.createElement("button");
                    exerciseDeleteBtn.type = "button";
                    exerciseDeleteBtn.textContent = "X";
                    exerciseDeleteBtn.classList.add("hide");
                    exerciseDeleteBtn.classList.add('delete-exercise-btn');
                    
                    exerciseItem.appendChild(exerciseName);
                    exerciseItem.appendChild(exerciseSets);
                    exerciseItem.appendChild(exerciseWeight);
                    exerciseItem.appendChild(exerciseReps);
                    exerciseItem.appendChild(exerciseDeleteBtn);

                    exerciseComponent.appendChild(exerciseItem);

                    workoutExercises.appendChild(exerciseComponent);
                });
                }

                // Add exercise btn
                const goToExerciseSelectorBtn = document.createElement("button");
                goToExerciseSelectorBtn.textContent = "+ Add Exercise";
                goToExerciseSelectorBtn.classList.add('hide');
                goToExerciseSelectorBtn.setAttribute("data-id", workout.wid);
                goToExerciseSelectorBtn.classList.add("add-exercise-btn")
                

                // Button Panel
                const buttonPanel = document.createElement("div");
                buttonPanel.classList = "button-panel";

                const startWorkoutBtn = document.createElement("button");
                startWorkoutBtn.type = "button";
                startWorkoutBtn.textContent = "Start Workout";
                startWorkoutBtn.classList.add("start-btn")
                startWorkoutBtn.setAttribute("data-id", workout.wid)

                const deleteWorkoutBtn = document.createElement("button");
                deleteWorkoutBtn.type = "button";
                deleteWorkoutBtn.textContent = "Delete Workout";
                deleteWorkoutBtn.classList.add('hide');
                deleteWorkoutBtn.classList.add('delete-btn');

                buttonPanel.appendChild(startWorkoutBtn);
                buttonPanel.appendChild(deleteWorkoutBtn);
                
                // Add all the elements to the workout section
                workoutSection.appendChild(workoutName);
                workoutSection.appendChild(editWorkoutNameBtn);
                workoutSection.appendChild(workoutExercises);
                workoutSection.appendChild(goToExerciseSelectorBtn);
                workoutSection.appendChild(buttonPanel);

                // Add the workout section to the workout container
                workoutContainer.appendChild(workoutSection);
            }
        
            async function initialRender() {
                const workouts = await serverGetWorkouts();
                for (const workout of workouts) {
                    await createWorkout(workout);
                }
            }
            initialRender();

            /***************************
                Create and Edit Mode
            ***************************/
            function toggleCreateMode() {
                editBtn.disabled = !editBtn.disabled;
                workoutPanel.classList.toggle("hide");
                workoutPanel.classList.toggle("show");
            }

            function toggleEditMode() {
                createBtn.disabled = !createBtn.disabled;
                const workouts = workoutContainer.querySelectorAll("section");
                workouts.forEach(workout => {
                    const workoutName = workout.querySelector("input");
                    const editWorkoutNameBtn = workout.querySelector(".edit-name");
                    const goToExerciseSelectorBtn = workout.querySelector(".add-exercise-btn");
                    const deleteWorkoutBtn = workout.querySelector(".delete-btn");
                    const deleteExerciseBtns = workout.querySelectorAll(".delete-exercise-btn");
                    
                    workoutName.disabled = !workoutName.disabled;
                    workoutName.classList.toggle("show");
                    editWorkoutNameBtn.classList.toggle("hide");
                    goToExerciseSelectorBtn.classList.toggle("hide");
                    deleteWorkoutBtn.classList.toggle("hide");
                    deleteExerciseBtns.forEach(button => {
                        button.classList.toggle("hide");
                    }); 
                });
            }
            
            /******************************
                    Notification
            ******************************/
            function notify(message) {
                notification.textContent = message;
                notification.classList.add("show");
                setTimeout(() => {notification.classList.remove("show");}, 2000);
            }

            /******************************
                    Workout Actions
            ******************************/
            async function addWorkout() {
                const workoutName = workoutPanel.name.value;
                const newWorkout = await serverCreateWorkout(workoutName);
                createWorkout(newWorkout);
                notify("Workout Successfully Added!");
            }

            async function deleteWorkout(e) {
                if (e.target && e.target.classList.contains("delete-btn")) {
                    const workout = e.target.closest("section");
                    const workoutId = workout.id;
                    const response = await serverDeleteWorkout(workoutId);
                    workout.remove();
                    notify(response);
                }
            }

            async function editWorkoutName(e) {
                if (e.target && e.target.classList.contains("edit-name")) {
                    const section = e.target.closest("section");
                    const workoutId = section.id;
                    const newName = section.querySelector("input").value;
                    const response = await serverUpdateWorkout(workoutId, newName);
                    notify(response);
                }
            }
            
            /******************************
                    Exercise Actions
            ******************************/
            async function deleteExercise(e) {
                if (e.target && e.target.classList.contains("delete-exercise-btn")) {
                    const workout = e.target.closest("section");
                    const li = e.target.closest("li")
                    const wid = workout.id;
                    const eid = li.value;
                    const response = await serverDeleteExercise(wid, eid);
                    li.remove();
                    notify(response);
                }
            }

            function goToExerciseSelector(e) {
                e.preventDefault();
                if (e.target && e.target.classList.contains("add-exercise-btn")) {
                    window.location.href = `exercise_selection.html?wid=${e.target.getAttribute("data-id")}`;
                }
            }

            /******************************
                    Start Workout
            ******************************/
            function startWorkout(e) {
                if (e.target && e.target.classList.contains("start-btn")) {
                    window.location.href = `workout.html?wid=${e.target.getAttribute("data-id")}`;
                }
            }

            createBtn.addEventListener("click", toggleCreateMode);
            addWorkoutBtn.addEventListener("click", addWorkout);
            editBtn.addEventListener("click", toggleEditMode);
            workoutContainer.addEventListener("click", deleteWorkout);
            workoutContainer.addEventListener("click", deleteExercise);
            workoutContainer.addEventListener("click", editWorkoutName);
            workoutContainer.addEventListener("click", startWorkout);
            workoutContainer.addEventListener("click", goToExerciseSelector);
        </script>
    </body>
</html>